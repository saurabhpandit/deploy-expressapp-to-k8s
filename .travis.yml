language: node_js
node_js:
- 10
services:
- docker
jobs:
  include:
  - stage: test
    install: npm install
    script:
    - npm test
  - stage: build and publish docker image
    script:
    - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker build -t $DOCKER_USERNAME/deploy-expressapp-to-k8s:$TRAVIS_BUILD_NUMBER
      --build-arg SHA=$(git rev-parse --short HEAD) .
    deploy:
    - provider: script
      script: ./bin/docker_push.sh
      on:
        branch: master
    - provider: script
      script: ./bin/docker_push.sh
      on:
        tags: true

env:
  global:
    secure: whc9lrh5Hl8vhk/atNdP9Zs0lq39W+IZTHVOJT2QW37eHS3OAiAyY7/ncbK/1z9bRL0sCuON2Jj557YxpqhchrDvw035rGlpvETA9JvVRyPtGI/Zb/awsFNkbQvWM0hUCUyQCGSXk4D2Yfes4L99Bf2SG3IwOMG1QEM5dcCYP8fzWNWODuwxSXbV21OJqq4RVU0OnBaRM1uyVhPjkuzFBOnbR0XVT8rBpy0umheHdo1ftynqb1oFWrGQwRdclg4QW59v6r0A5IhtWkv5iMA/K1wBHOWGc0jugQaANQA7UDhvhzgD0/4huQpRMWyG2qxp3SCzB6na6EbschXPX0KWtYoOi4wJ23PbA1vhUsM8ovfyIvNHgrnOIVk6Gp5Pj40PJt2jvC4rweER+to1NLD5nqkBtDz9+iPSmBg17clbJYI/CGSsBm0iN6BpYIT8x65PkTOtLHlO7eJgyvi1uOYhUJttZaoJVUDKThKLz7qAy0UriZa1qBZqZ0j78YQvOg1c5E+3J+1UQKCh6abmqCt5RL8FK2Ka6Rh0TQSGRX8FXdnRdtgItGNWLQUKEcMrO/kT7SXHKyuehXqRUs2tNUZhkKyBnG1YqsBe5eXycb1xF7uOJcDGYlm2i1EhP12uvkNFqaTaSzBO/+Z/b03duiD2S7+AwuU2oPTn4uJ97reQo1M=
